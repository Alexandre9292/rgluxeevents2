{% extends 'base.html' %}
{% load static %}

{% block title %}RG Luxe Events - Transport{% endblock %}

{% block content %}
<!-- Banner principal avec le design de l'image -->
<div class="hero-banner" style="display: none;">
    <div class="banner-content">
        <div class="banner-left">
            <div class="transport-panel">
                <div class="transport-image">
                    <img src="{% static 'images/voiture-porsche.jpg' %}" alt="Transport de luxe">
                    <div class="transport-overlay">
                        <div class="luxury-car">
                            <img src="{% static 'images/voiture-amg.jpg' %}" alt="Voiture de luxe">
                        </div>
                        <div class="private-jet">
                            <img src="{% static 'images/aeroport.jpg' %}" alt="Jet privé">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="banner-center">
            <div class="logo-container">
                <div class="main-logo">
                    <h1>RG Luxe Events</h1>
                </div>
            </div>
            <div class="drone-panel">
                <div class="drone-image">
                    <img src="{% static 'images/service-aeroport.jpg' %}" alt="Services drone">
                </div>
            </div>
        </div>
        
        <div class="banner-right">
            <div class="photobooth-panel">
                <div class="photobooth-image">
                    <img src="{% static 'images/service-mariage.jpg' %}" alt="Photobooth">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image bannière haute -->
<div class="ban-haut">
    <img src="{% static 'images/ban_haut.jpg' %}" alt="Bannière RG Luxe Events">
</div>

<!-- Section principale -->
<section class="transport-section">
    <div class="container">
        <div class="transport-content">
            <!-- Formulaire de réservation -->
            <div class="booking-form-container">
                <h2>Réservation</h2>
                
                <!-- Onglets -->
                <div class="tabs">
                    <button class="tab-button active" data-tab="transport">Transport</button>
                    <button class="tab-button" data-tab="aeroport">Aéroport</button>
                </div>
                
                <!-- Onglet Transport -->
                <div class="tab-content active" id="transport-tab">
                    <form method="post" class="booking-form" id="transport-form">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="form-group">
                                <label for="id_departure">Lieu de départ</label>
                                <input type="text" id="id_departure" name="departure" class="places-autocomplete" placeholder="Entrez votre adresse de départ" required>
                                <input type="hidden" id="departure_lat" name="departure_lat">
                                <input type="hidden" id="departure_lng" name="departure_lng">
                            </div>
                            <div class="form-group">
                                <label for="id_arrival">Lieu d'arrivée</label>
                                <input type="text" id="id_arrival" name="arrival" class="places-autocomplete" placeholder="Entrez votre adresse d'arrivée" required>
                                <input type="hidden" id="arrival_lat" name="arrival_lat">
                                <input type="hidden" id="arrival_lng" name="arrival_lng">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                {{ transport_form.departure_date.label_tag }}
                                {{ transport_form.departure_date }}
                            </div>
                            <div class="form-group">
                                {{ transport_form.departure_time.label_tag }}
                                {{ transport_form.departure_time }}
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                {{ transport_form.passengers.label_tag }}
                                {{ transport_form.passengers }}
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    {{ transport_form.return_trip }}
                                    <span>Aller-retour</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="return-fields" id="return-fields" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    {{ transport_form.return_date.label_tag }}
                                    {{ transport_form.return_date }}
                                </div>
                                <div class="form-group">
                                    {{ transport_form.return_time.label_tag }}
                                    {{ transport_form.return_time }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Affichage de la distance et du prix estimé -->
                        <div class="route-info" id="route-info" style="display: none;">
                            <div class="info-row">
                                <div class="info-item">
                                    <span class="info-label">Distance :</span>
                                    <span class="info-value" id="distance-value">0 km</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Prix estimé :</span>
                                    <span class="info-value" id="price-value">0€</span>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" name="transport_submit" class="btn btn-primary">Calculer le prix</button>
                    </form>
                </div>
                
                <!-- Onglet Aéroport -->
                <div class="tab-content" id="aeroport-tab">
                    <form method="post" class="booking-form" id="aeroport-form">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="form-group">
                                {{ aeroport_form.service_type.label_tag }}
                                {{ aeroport_form.service_type }}
                            </div>
                        </div>
                        
                        <!-- Champ aéroport fixe -->
                        <div class="form-group">
                            <label id="airport-label">Aéroport</label>
                            <input type="text" id="airport_address" name="airport_address" value="Aéroport Roland Garros, Saint-Marie, La Réunion" readonly class="airport-field">
                        </div>
                        
                        <!-- Champ d'adresse dynamique selon le type de service -->
                        <div class="form-group" id="aeroport-address-field" style="display: none;">
                            <label for="aeroport_address" id="aeroport-address-label">Adresse</label>
                            <input type="text" id="aeroport_address" name="aeroport_address" class="places-autocomplete" placeholder="Entrez votre adresse" required>
                            <input type="hidden" id="aeroport_address_lat" name="aeroport_address_lat">
                            <input type="hidden" id="aeroport_address_lng" name="aeroport_address_lng">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                {{ aeroport_form.departure_date.label_tag }}
                                {{ aeroport_form.departure_date }}
                            </div>
                            <div class="form-group">
                                {{ aeroport_form.departure_time.label_tag }}
                                {{ aeroport_form.departure_time }}
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                {{ aeroport_form.passengers.label_tag }}
                                {{ aeroport_form.passengers }}
                            </div>
                            <div class="form-group">
                                {{ aeroport_form.luggage.label_tag }}
                                {{ aeroport_form.luggage }}
                            </div>
                        </div>
                        
                        <!-- Affichage du prix estimé pour l'aéroport -->
                        <div class="route-info" id="aeroport-route-info" style="display: none;">
                            <div class="info-row">
                                <div class="info-item">
                                    <span class="info-label">Distance :</span>
                                    <span class="info-value" id="aeroport-distance-value">0 km</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Prix estimé :</span>
                                    <span class="info-value" id="aeroport-price-value">0€</span>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" name="aeroport_submit" class="btn btn-primary">Calculer le prix</button>
                    </form>
                </div>
            </div>
            
            <!-- Carte Google Maps -->
            <div class="map-container">
                <div id="map"></div>
                <div class="map-info">
                    <h3>Votre trajet</h3>
                    <div id="map-route-info">
                        <p>Saisissez vos informations pour voir l'itinéraire</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Section présentation du service -->
<section class="service-presentation-section">
    <div class="container">
        <div class="service-content">
            <h2>TRANSPORT AVEC CHAUFFEUR PRIVÉ</h2>
            <p class="service-intro">Un événement à venir ? Mariage, soirée privée, sortie entre amis ou escapade de dernière minute ?</p>
            <p class="service-description">Offrez-vous la tranquilité avec notre service de transport VTC haut de gamme.</p>
            
            <div class="service-features">
                <div class="feature-list">
                    <h3>Nos Services</h3>
                    <ul>
                        <li>Transport des invités pour vos événements</li>
                        <li>Transferts aéroport</li>
                        <li>Sorties nocturnes</li>
                        <li>Déplacements professionnels ou privés</li>
                    </ul>
                </div>
                
                <div class="feature-list">
                    <h3>Profitez pleinement de votre soirée sans vous soucier du retour :</h3>
                    <ul>
                        <li>Savourez un verre l'esprit léger</li>
                        <li>Évitez les risques liés à la fatigue ou trajets nocturnes</li>
                        <li>Oubliez les soucis de circulation et de stationnement</li>
                    </ul>
                </div>
            </div>
            
            <p class="service-conclusion">Laissez-nous assurer vos déplacements en toute sérénité, du départ jusqu'à votre retour, de jour comme de nuit.</p>
        </div>
    </div>
</section>

<script>
// Variables globales
let map, directionsService, directionsRenderer;
let departureMarker, arrivalMarker;
let currentRoute = null;

// Initialisation de la carte Google Maps
function initMap() {
    // Centre de la carte sur La Réunion
    const reunionCenter = { lat: -21.1151, lng: 55.5364 };
    
    // Initialisation de la carte
    map = new google.maps.Map(document.getElementById('map'), {
        center: reunionCenter,
        zoom: 10,
        styles: [
            {
                featureType: "poi",
                elementType: "labels",
                stylers: [{ visibility: "off" }]
            }
        ]
    });
    
    // Services de directions
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
        polylineOptions: {
            strokeColor: '#dbc067',
            strokeWeight: 4
        }
    });
    directionsRenderer.setMap(map);
    
    // Marqueur pour l'aéroport Roland Garros
    const airportMarker = new google.maps.Marker({
        position: { lat: -20.890089, lng: 55.516448 },
        map: map,
        title: 'Aéroport Roland Garros',
        icon: {
            url: 'https://maps.google.com/mapfiles/ms/icons/airport.png',
            scaledSize: new google.maps.Size(32, 32)
        }
    });
    
    // Initialisation de l'autocomplétion
    initAutocomplete();
}

// Initialisation de l'autocomplétion Google Places
function initAutocomplete() {
    const departureInput = document.getElementById('id_departure');
    const arrivalInput = document.getElementById('id_arrival');
    const aeroportAddressInput = document.getElementById('aeroport_address');
    
    // Autocomplétion pour le départ
    const departureAutocomplete = new google.maps.places.Autocomplete(departureInput, {
        componentRestrictions: { country: 're' }, // Restriction à La Réunion
        types: ['geocode', 'establishment']
    });
    
    // Autocomplétion pour l'arrivée
    const arrivalAutocomplete = new google.maps.places.Autocomplete(arrivalInput, {
        componentRestrictions: { country: 're' }, // Restriction à La Réunion
        types: ['geocode', 'establishment']
    });
    
    // Autocomplétion pour l'adresse aéroport
    const aeroportAddressAutocomplete = new google.maps.places.Autocomplete(aeroportAddressInput, {
        componentRestrictions: { country: 're' }, // Restriction à La Réunion
        types: ['geocode', 'establishment']
    });
    
    // Événement de sélection pour le départ
    departureAutocomplete.addListener('place_changed', function() {
        const place = departureAutocomplete.getPlace();
        if (place.geometry) {
            document.getElementById('departure_lat').value = place.geometry.location.lat();
            document.getElementById('departure_lng').value = place.geometry.location.lng();
            
            // Mettre à jour le marqueur de départ
            if (departureMarker) departureMarker.setMap(null);
            departureMarker = new google.maps.Marker({
                position: place.geometry.location,
                map: map,
                title: 'Départ',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#28a745',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2
                }
            });
            
            // Calculer l'itinéraire si l'arrivée est aussi définie
            if (document.getElementById('arrival_lat').value && document.getElementById('arrival_lng').value) {
                calculateRoute();
            }
        }
    });
    
    // Événement de sélection pour l'arrivée
    arrivalAutocomplete.addListener('place_changed', function() {
        const place = arrivalAutocomplete.getPlace();
        if (place.geometry) {
            document.getElementById('arrival_lat').value = place.geometry.location.lat();
            document.getElementById('arrival_lng').value = place.geometry.location.lng();
            
            // Mettre à jour le marqueur d'arrivée
            if (arrivalMarker) arrivalMarker.setMap(null);
            arrivalMarker = new google.maps.Marker({
                position: place.geometry.location,
                map: map,
                title: 'Arrivée',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#dc3545',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2
                }
            });
            
            // Calculer l'itinéraire si le départ est aussi défini
            if (document.getElementById('departure_lat').value && document.getElementById('departure_lng').value) {
                calculateRoute();
            }
        }
    });
    
    // Événement de sélection pour l'adresse aéroport
    aeroportAddressAutocomplete.addListener('place_changed', function() {
        const place = aeroportAddressAutocomplete.getPlace();
        if (place.geometry) {
            document.getElementById('aeroport_address_lat').value = place.geometry.location.lat();
            document.getElementById('aeroport_address_lng').value = place.geometry.location.lng();
            
            // Calculer l'itinéraire aéroport
            calculateAeroportRoute();
        }
    });
}

// Calcul de l'itinéraire
function calculateRoute() {
    const departureLat = parseFloat(document.getElementById('departure_lat').value);
    const departureLng = parseFloat(document.getElementById('departure_lng').value);
    const arrivalLat = parseFloat(document.getElementById('arrival_lat').value);
    const arrivalLng = parseFloat(document.getElementById('arrival_lng').value);
    
    if (!departureLat || !departureLng || !arrivalLat || !arrivalLng) return;
    
    const request = {
        origin: { lat: departureLat, lng: departureLng },
        destination: { lat: arrivalLat, lng: arrivalLng },
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.METRIC
    };
    
    directionsService.route(request, function(result, status) {
        if (status === 'OK') {
            directionsRenderer.setDirections(result);
            currentRoute = result;
            
            // Calculer la distance
            const distance = result.routes[0].legs[0].distance.value / 1000; // Conversion en km
            
            // Calculer le prix selon le type de service
            const activeTab = document.querySelector('.tab-button.active').getAttribute('data-tab');
            let price = 0;
            
            if (activeTab === 'transport') {
                if (distance <= 50) {
                    price = distance * 2.25;
                } else if (distance <= 100) {
                    price = distance * 1.90;
                } else {
                    price = distance * 1.50;
                }
                
                // Afficher les informations
                document.getElementById('distance-value').textContent = distance.toFixed(1) + ' km';
                document.getElementById('price-value').textContent = price.toFixed(2) + '€';
                document.getElementById('route-info').style.display = 'block';
                
            } else if (activeTab === 'aeroport') {
                if (distance <= 30) {
                    price = distance * 2.00;
                } else {
                    price = distance * 1.50;
                }
                
                // Afficher les informations
                document.getElementById('aeroport-distance-value').textContent = distance.toFixed(1) + ' km';
                document.getElementById('aeroport-price-value').textContent = price.toFixed(2) + '€';
                document.getElementById('aeroport-route-info').style.display = 'block';
            }
            
            // Mettre à jour les informations de la carte
            updateMapInfo(distance, price);
            
            // Ajuster la vue de la carte pour inclure tout l'itinéraire
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(request.origin);
            bounds.extend(request.destination);
            map.fitBounds(bounds);
        }
    });
}

// Calcul de l'itinéraire aéroport
function calculateAeroportRoute() {
    const serviceType = document.getElementById('id_service_type').value;
    const aeroportAddressLat = parseFloat(document.getElementById('aeroport_address_lat').value);
    const aeroportAddressLng = parseFloat(document.getElementById('aeroport_address_lng').value);
    
    if (!aeroportAddressLat || !aeroportAddressLng) return;
    
    // Coordonnées de l'aéroport Roland Garros
    const airportLat = -20.890089;
    const airportLng = 55.516448;
    
    let origin, destination;
    
    if (serviceType === 'venir') {
        // Venir me chercher : de l'aéroport vers l'adresse client
        origin = { lat: airportLat, lng: airportLng };
        destination = { lat: aeroportAddressLat, lng: aeroportAddressLng };
    } else if (serviceType === 'deposer') {
        // Me déposer : de l'adresse client vers l'aéroport
        origin = { lat: aeroportAddressLat, lng: aeroportAddressLng };
        destination = { lat: airportLat, lng: airportLng };
    }
    
    if (origin && destination) {
        const request = {
            origin: origin,
            destination: destination,
            travelMode: google.maps.TravelMode.DRIVING,
            unitSystem: google.maps.UnitSystem.METRIC
        };
        
        directionsService.route(request, function(result, status) {
            if (status === 'OK') {
                directionsRenderer.setDirections(result);
                currentRoute = result;
                
                // Calculer la distance
                const distance = result.routes[0].legs[0].distance.value / 1000; // Conversion en km
                
                // Calculer le prix selon la grille tarifaire aéroport
                let price = 0;
                if (distance <= 30) {
                    price = distance * 2.00;
                } else {
                    price = distance * 1.50;
                }
                
                // Afficher les informations
                document.getElementById('aeroport-distance-value').textContent = distance.toFixed(1) + ' km';
                document.getElementById('aeroport-price-value').textContent = price.toFixed(2) + '€';
                document.getElementById('aeroport-route-info').style.display = 'block';
                
                // Mettre à jour les informations de la carte
                updateMapInfo(distance, price);
                
                // Ajuster la vue de la carte pour inclure tout l'itinéraire
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(origin);
                bounds.extend(destination);
                map.fitBounds(bounds);
                
                // Mettre à jour les marqueurs
                updateAeroportMarkers(origin, destination);
            }
        });
    }
}

// Mise à jour des marqueurs pour l'aéroport
function updateAeroportMarkers(origin, destination) {
    // Supprimer les anciens marqueurs
    if (departureMarker) departureMarker.setMap(null);
    if (arrivalMarker) arrivalMarker.setMap(null);
    
    // Marqueur de départ
    departureMarker = new google.maps.Marker({
        position: origin,
        map: map,
        title: 'Départ',
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#28a745',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2
        }
    });
    
    // Marqueur d'arrivée
    arrivalMarker = new google.maps.Marker({
        position: destination,
        map: map,
        title: 'Arrivée',
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#dc3545',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2
        }
    });
}

// Mise à jour des informations de la carte
function updateMapInfo(distance, price) {
    const mapInfo = document.getElementById('map-route-info');
    mapInfo.innerHTML = `
        <div class="route-details">
            <p><strong>Distance :</strong> ${distance.toFixed(1)} km</p>
            <p><strong>Prix estimé :</strong> ${price.toFixed(2)}€</p>
        </div>
    `;
}

// Gestion des onglets
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabName = button.getAttribute('data-tab');
            
            // Retirer la classe active de tous les onglets
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Ajouter la classe active à l'onglet cliqué
            button.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Recalculer l'itinéraire si nécessaire
            if (currentRoute) {
                calculateRoute();
            }
        });
    });
    
    // Gestion des champs de retour
    const returnCheckbox = document.getElementById('id_return_trip');
    const returnFields = document.getElementById('return-fields');
    
    if (returnCheckbox) {
        returnCheckbox.addEventListener('change', function() {
            if (this.checked) {
                returnFields.style.display = 'block';
            } else {
                returnFields.style.display = 'none';
            }
        });
    }
    
    // Gestion du changement de type de service pour l'aéroport
    const serviceTypeSelect = document.getElementById('id_service_type');
    if (serviceTypeSelect) {
        serviceTypeSelect.addEventListener('change', function() {
            const addressField = document.getElementById('aeroport-address-field');
            const aeroportAddressInput = document.getElementById('aeroport_address');
            const aeroportAddressLat = document.getElementById('aeroport_address_lat');
            const aeroportAddressLng = document.getElementById('aeroport_address_lng');
            const aeroportAddressLabel = document.getElementById('aeroport-address-label');
            const airportLabel = document.getElementById('airport-label');
            
            // Réinitialiser les champs
            aeroportAddressInput.value = '';
            aeroportAddressLat.value = '';
            aeroportAddressLng.value = '';
            
            // Masquer les informations de route
            document.getElementById('aeroport-route-info').style.display = 'none';
            
            if (this.value === 'venir') {
                // Venir me chercher : de l'aéroport vers l'adresse client
                document.getElementById('id_arrival').value = 'Aéroport Roland Garros, La Réunion';
                document.getElementById('arrival_lat').value = '-20.890089';
                document.getElementById('arrival_lng').value = '55.516448';
                
                // Mettre à jour les labels
                airportLabel.textContent = 'Lieu de départ';
                aeroportAddressLabel.textContent = 'Adresse d\'arrivée';
                aeroportAddressInput.placeholder = 'Entrez votre adresse d\'arrivée';
                
                addressField.style.display = 'block'; // Afficher le champ d'adresse
                
            } else if (this.value === 'deposer') {
                // Me déposer : de l'adresse client vers l'aéroport
                document.getElementById('id_departure').value = 'Aéroport Roland Garros, La Réunion';
                document.getElementById('departure_lat').value = '-20.890089';
                document.getElementById('departure_lng').value = '55.516448';
                
                // Mettre à jour les labels
                airportLabel.textContent = 'Lieu d\'arrivée';
                aeroportAddressLabel.textContent = 'Adresse de départ';
                aeroportAddressInput.placeholder = 'Entrez votre adresse de départ';
                
                addressField.style.display = 'block'; // Afficher le champ d'adresse
                
            } else {
                // Pas de service sélectionné
                airportLabel.textContent = 'Aéroport';
                addressField.style.display = 'none'; // Masquer le champ d'adresse
            }
            
            // Effacer la carte si un itinéraire était affiché
            if (currentRoute) {
                directionsRenderer.setDirections({routes: []});
                currentRoute = null;
                if (departureMarker) departureMarker.setMap(null);
                if (arrivalMarker) arrivalMarker.setMap(null);
            }
        });
        serviceTypeSelect.dispatchEvent(new Event('change'));
    }
});
</script>

<!-- Chargement de l'API Google Maps avec Places -->
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCpYR4gr75AZB5wIVfS0d49G4-lTaSp4vY&libraries=places&callback=initMap">
</script>
{% endblock %} 